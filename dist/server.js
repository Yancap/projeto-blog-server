"use strict";var Re=Object.create;var T=Object.defineProperty;var qe=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var ve=Object.getPrototypeOf,xe=Object.prototype.hasOwnProperty;var B=(a,s)=>()=>(a&&(s=a(a=0)),s);var M=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),H=(a,s)=>{for(var e in s)T(a,e,{get:s[e],enumerable:!0})},J=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of Ae(s))!xe.call(a,r)&&r!==e&&T(a,r,{get:()=>s[r],enumerable:!(t=qe(s,r))||t.enumerable});return a};var R=(a,s,e)=>(e=a!=null?Re(ve(a)):{},J(s||!a||!a.__esModule?T(e,"default",{value:a,enumerable:!0}):e,a)),z=a=>J(T({},"__esModule",{value:!0}),a);var Q={};H(Q,{default:()=>m});var m,l=B(()=>{"use strict";m=class{message;status;typeError;code;constructor(s,e,t=400,r){this.message=s,this.typeError=e,this.status=t,this.code=r}}});var X=M((je,V)=>{"use strict";var K=R(require("path"));V.exports={development:{client:"sqlite3",connection:{filename:K.default.resolve(__dirname,"database.db")},pool:{afterCreate:(a,s)=>a.run("PRAGMA foreign_keys = ON",s)},useNullAsDefault:!0,migrations:{directory:K.default.resolve(__dirname,"src","database","knex","migrations")}}}});var W={};H(W,{default:()=>i});var Y,Z,ke,i,p=B(()=>{"use strict";Y=R(require("knex")),Z=R(X()),ke=(0,Y.default)(Z.default.development),i=ke});var S,ue=B(()=>{"use strict";p();S=class{async getArticlesByTitle(s){return await i("articles").whereLike("title",`%${s}%`)}async getArticlesBySubtitle(s){return await i("articles").whereLike("title",`%${s}%`)}async getArticlesByText(s){return await i("articles").whereLike("title",`%${s}%`)}cleanSearch(s){let e="a, \xE0, agora, ainda, algu\xE9m, algum, alguma, algumas, alguns, ampla, amplas, amplo, amplos, ante, antes, ao, aos, ap\xF3s, aquela, aquelas, aquele, aqueles, aquilo, as, at\xE9, atrav\xE9s, cada, coisa, coisas, com, como, contra, contudo, da, daquele, daqueles, das, de, dela, delas, dele, deles, depois, dessa, dessas, desse, desses, desta, destas, deste, deste, destes, deve, devem, devendo, dever, dever\xE1, dever\xE3o, deveria, deveriam, devia, deviam, disse, disso, disto, dito, diz, dizem, do, dos, e, \xE9, ela, elas, ele, eles, em, enquanto, entre, era, essa, essas, esse, esses, esta, est\xE1, estamos, est\xE3o, estas, estava, estavam, est\xE1vamos, este, estes, estou, eu, fazendo, fazer, feita, feitas, feito, feitos, foi, for, foram, fosse, fossem, grande, grandes, h\xE1, isso, isto, j\xE1, la, l\xE1, lhe, lhes, lo, mas, me, mesma, mesmas, mesmo, mesmos, meu, meus, minha, minhas, muita, muitas, muito, muitos, na, n\xE3o, nas, nem, nenhum, nessa, nessas, nesta, nestas, ningu\xE9m, no, nos, n\xF3s, nossa, nossas, nosso, nossos, num, numa, nunca, o, os, ou, outra, outras, outro, outros, para, pela, pelas, pelo, pelos, pequena, pequenas, pequeno, pequenos, per, perante, pode, pude, podendo, poder, poderia, poderiam, podia, podiam, pois, por, por\xE9m, porque, posso, pouca, poucas, pouco, poucos, primeiro, primeiros, pr\xF3pria, pr\xF3prias, pr\xF3prio, pr\xF3prios, quais, qual, quando, quanto, quantos, que, quem, s\xE3o, se, seja, sejam, sem, sempre, sendo, ser\xE1, ser\xE3o, seu, seus, si, sido, s\xF3, sob, sobre, sua, suas, talvez, tamb\xE9m, tampouco, te, tem, tendo, tenha, ter, teu, teus, ti, tido, tinha, tinham, toda, todas, todavia, todo, todos, tu, tua, tuas, tudo, \xFAltima, \xFAltimas, \xFAltimo, \xFAltimos, um, uma, umas, uns, vendo, ver, vez, vindo, vir, vos, v\xF3s".split(", ");return s.split(" ").filter(r=>r&&e.every(o=>r.toLowerCase()!==o))}async searchArticleService(s){let e=this.cleanSearch(s),t=[],r=[];for(let c of e)t.push(await this.getArticlesByText(c)),t.push(await this.getArticlesByTitle(c)),t.push(await this.getArticlesBySubtitle(c));t.forEach(c=>{c.map(u=>r.push(u))});let o={};return r.filter(c=>o.hasOwnProperty(c.id)?!1:o={...o,[c.id]:!0})}}});var ds,ls,be,E,me=B(()=>{"use strict";ue();ds=(p(),z(W)),ls=(l(),z(Q)),be=new S,E=class{async index(s,e){let{content:t,author:r}=s.query,o=await be.searchArticleService(t);e.json(o)}}});var fe=M((hs,pe)=>{"use strict";var de=require("express");me();var le=(0,de.Router)(),Ce=new E;le.get("/",Ce.index);pe.exports=le});var $=R(require("express"));l();var he=require("express");var se=require("express");p();var q=class{async checkUsersPermissionsForCreate(s){let e=await i("users").where({id:s}).first();return!!(e.hierarchy&&e.hierarchy!=="reader")}async checkUsersPermissionForEdit(s,e){return!!await i("articles").where({id:e}).andWhere({user_id:s}).first()}async createArticle({title:s,subtitle:e,text:t,user_id:r,image:o,author:n}){try{return await i("articles").insert({title:s,subtitle:e,text:t,user_id:r,image:o,author:n}),{message:"Success"}}catch(c){return{error:c}}}async updateArticle({title:s,subtitle:e,text:t,article_id:r,user_id:o,image:n}){if(!this.checkUsersPermissionForEdit(o,r))return{message:"forbidden"};let u={};s&&(u={...u,title:s}),e&&(u={...u,subtitle:e}),t&&(u={...u,text:t}),n&&(u={...u,image:n}),console.log(u);try{await i("articles").where({id:r}).update(u)}catch(g){return{error:g}}return{message:"Success"}}async deleteArticle({user_id:s,article_id:e}){if(!this.checkUsersPermissionForEdit(s,e))return{message:"forbidden"};try{return await i("articles").where({id:e}).delete(),{message:"OK"}}catch(r){return{error:r}}}async getAllArticles(){return await i("articles")}async getArticleById(s){return await i("articles").where({id:s}).first()}async getArticlesByUserId(s){return await i("articles").where({user_id:s})}};l();var f=new q,A=class{async create(s,e){let{title:t,subtitle:r,text:o,user_id:n,image:c,author:u}=s.body;if(!await f.checkUsersPermissionsForCreate(n))return e.json({message:"Sem Permiss\xE3o",error:"forbidden"});let G=await f.createArticle({title:t,subtitle:r,text:o,user_id:n,image:c,author:u});return e.json(G)}async update(s,e){let{title:t,subtitle:r,text:o,article_id:n,user_id:c,image:u}=s.body,g=await f.updateArticle({title:t,subtitle:r,text:o,article_id:n,image:u,user_id:c});return e.json(g)}async delete(s,e){let{user_id:t,article_id:r}=s.body,o=await f.deleteArticle({article_id:r,user_id:t});return e.json(o)}async index(s,e){let t=await f.getAllArticles();e.json(t)}async show(s,e){let{id:t}=s.query,{user_id:r}=s.query;if(t){let o=await f.getArticleById(t);return o||e.send(new m("Esse Artigo n\xE3o existe ou foi excluido","not_found",404)),e.json(o)}else if(r){let o=await f.getArticlesByUserId(r);return o||e.send(new m("Esse Artigo n\xE3o existe ou foi excluido","not_found",404)),e.json(o)}else return e.send(new m("Sem Par\xE2metros","not_found",404))}};var ee=require("jsonwebtoken");var I={jwt:{secret:"default",expiresIn:"1d"}};async function d(a,s,e){let t=a.headers.authorization;if(t){let[,r]=t.split(" ");if(!r)return e();try{let{sub:o}=(0,ee.verify)(r,I.jwt.secret);return a.body={...a.body,token:r,user_id:Number(o)},e()}catch{return s.json({redirect:!0,message:"Token expired or invalid"})}}return e()}l();function v(a,s,e){let{user_id:t}=a.body;if(!t)throw new m({redirect:!0,error:"User not logged in"},"not logged in");e()}var h=(0,se.Router)(),w=new A;h.post("/create",d,v,w.create);h.put("/update",d,v,w.update);h.delete("/delete",d,v,w.delete);h.get("/show",w.show);h.get("/show/user",d,w.show);h.get("/show-all",w.index);var te=h;var re=require("express");p();var x=class{async createComment({user_id:s,article_id:e,title:t,text:r,name:o}){try{o||(o=await(await i("users").where({id:s}).first()).name),await i("comments").insert({user_id:s,article_id:e,title:t,text:r,name:o})}catch(n){return{error:n}}return{message:"OK"}}async deleteComment({comments_id:s,article_id:e,user_id:t}){try{return await i("comments").where({id:s}).andWhere({article_id:e}).andWhere({user_id:t}).delete(),{message:"Success"}}catch(r){return{error:r}}}async getAllComments(s){try{return await i("comments").where({article_id:s})}catch(e){return e}}async getCommentById(s){try{return await i("comments").where({id:s}).first()}catch(e){return e}}};l();var L=new x,k=class{async create(s,e){let{user_id:t,article_id:r,title:o,text:n,name:c}=s.body,u=await L.createComment({user_id:t,article_id:r,title:o,text:n,name:c});return e.json(u)}async index(s,e){let{article_id:t}=s.query,r=await L.getAllComments(t);return e.json(r)}async delete(s,e){let{comments_id:t,article_id:r,user_id:o}=s.body;if(!t)throw new m("Coment\xE1rio Inexistente ou Exclu\xEDdo","not_found",404);let n=await L.deleteComment({comments_id:t,article_id:r,user_id:o});return e.json(n)}async show(s,e){let{id:t}=s.query,r=await L.getCommentById(t);return e.json(r)}};var b=(0,re.Router)(),N=new k;b.post("/create",d,N.create);b.delete("/delete",d,N.delete);b.get("/all",N.index);b.get("/show",N.show);var oe=b;var ie=require("express");var ne=require("bcryptjs");var C=require("bcryptjs"),ae=require("jsonwebtoken");p();var Ze=(p(),z(W)),O=class{constructor(){}async login(s){let{user_id:e,token:t,email:r,password:o}=s;if(e&&t){let F=await i("users").where({id:e}).first();return{token:t,user_id:F.user_id,name:F.name,avatar:F.avatar,hierarchy:F.hierarchy}}if(!r&&!o)return{error:"login failed",message:"Sem dados",redirect:!0};let n=await i("users").where({email:r}).first();if(!n)return{error:"login failed",message:"Dados incorretos"};if(!(0,C.compare)(o,n.password))return{error:"login failed",message:"Dados incorretos"};let{secret:u,expiresIn:g}=I.jwt;return{token:(0,ae.sign)({},u,{subject:String(n.id),expiresIn:g}),user_id:n.id,name:n.name,avatar:n.avatar,hierarchy:n.hierarchy}}async register(s){let{name:e,email:t,password:r}=s;if(await i("users").where({email:t}).first())return{error:"register failed",message:"Email Existente"};try{let n={name:e,email:t,avatar:null,password:r,hierarchy:"reader"};return await i("users").insert(n),{message:"OK"}}catch(n){return{error:n,message:"CRUD"}}}async changePassword(s){let{user_id:e,oldPassword:t,newPassword:r}=s,o=await(await i("users").where({id:e}).first()).password;if(await(0,C.compare)(t,o))return{error:"update-password failed",message:"Senha Incorreta"};let c=await(0,C.hash)(r,8);try{await i("users").where({id:e}).update({password:c})}catch(u){return{error:u,message:"CRUD"}}return{message:"Senha alterada com sucesso"}}async changeAvatar(s){let{user_id:e,avatar:t}=s;try{await i("users").where({id:e}).update({avatar:t})}catch(r){return{error:r,message:"CRUD"}}return{message:"OK"}}async getAuthor(s){try{let e=await i("users").where({id:s}).first();return e?{id:e.id,name:e.name,avatar:e.avatar}:{error:"user not_found",message:"Usu\xE1rio n\xE3o encontrado"}}catch(e){return{error:e,message:"Server Error"}}}};l();var _=new O,P=class{async login(s,e){let{token:t,user_id:r,email:o,password:n}=s.body,c=await _.login({token:t,user_id:r,email:o,password:n});return e.json(c)}async create(s,e){let{name:t,email:r,password:o}=s.body,n=await(0,ne.hash)(o,8),c=await _.register({name:t,email:r,password:n});return e.json(c)}async update(s,e){let{user_id:t,avatar:r,newPassword:o,oldPassword:n}=s.body;if(!t)throw new m("Sem Dados","redirect",401,"/login");if(n&&!o||!n&&o)throw new m("Digite as Duas Senhas","update-password");if(r){let c=await _.changeAvatar;return e.json({message:c})}else if(o){let c=await _.changePassword({user_id:t,newPassword:o,oldPassword:n});return e.json({message:c})}else throw new m("Sem Dados","redirect",401,"/login")}async getAuthor(s,e){let{id:t}=s.query;if(!t)throw new m("Sem Dados");let r=await _.getAuthor(t);return e.json(r)}};var y=(0,ie.Router)(),j=new P;y.post("/login",d,j.login);y.post("/register",j.create);y.put("/avatar",d,j.update);y.put("/change-password",d,j.update);y.get("/author",j.getAuthor);var ce=y;var D=(0,he.Router)(),_e=fe();D.use("/users",ce);D.use("/comments",oe);D.use("/articles",te);D.use("/search",_e);var ge=D;var ye=R(require("cors"));require("express-async-errors");var U=(0,$.default)();U.use((0,ye.default)());U.use($.default.json({limit:"5mb"}));U.use(ge);U.use(async(a,s,e,t)=>a instanceof m?e.status(a.status).json({status:"error",message:a.message,typeError:a.typeError}):e.status(500).json({status:"error",message:"erro do servidor"}));var we=process.env.PORT||3001;U.listen(we,()=>console.log("Server is Running:",we));
