"use strict";var Re=Object.create;var T=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,ve=Object.prototype.hasOwnProperty;var z=(a,s)=>()=>(a&&(s=a(a=0)),s);var M=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),H=(a,s)=>{for(var e in s)T(a,e,{get:s[e],enumerable:!0})},J=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of qe(s))!ve.call(a,r)&&r!==e&&T(a,r,{get:()=>s[r],enumerable:!(t=Ae(s,r))||t.enumerable});return a};var R=(a,s,e)=>(e=a!=null?Re(xe(a)):{},J(s||!a||!a.__esModule?T(e,"default",{value:a,enumerable:!0}):e,a)),O=a=>J(T({},"__esModule",{value:!0}),a);var Q={};H(Q,{default:()=>u});var u,p=z(()=>{"use strict";u=class{message;status;typeError;code;constructor(s,e,t=400,r){this.message=s,this.typeError=e,this.status=t,this.code=r}}});var X=M((Pe,V)=>{"use strict";var W=R(require("path"));V.exports={development:{client:"sqlite3",connection:{filename:W.default.resolve(__dirname,"database.db")},pool:{afterCreate:(a,s)=>a.run("PRAGMA foreign_keys = ON",s)},useNullAsDefault:!0,migrations:{directory:W.default.resolve(__dirname,"src","database","knex","migrations")}}}});var $={};H($,{default:()=>i});var Y,Z,be,i,f=z(()=>{"use strict";Y=R(require("knex")),Z=R(X()),be=(0,Y.default)(Z.default.development),i=be});var S,ue=z(()=>{"use strict";f();S=class{async getArticlesByTitle(s){return await i("articles").whereLike("title",`%${s}%`)}async getArticlesBySubtitle(s){return await i("articles").whereLike("subtitle",`%${s}%`)}async getArticlesByText(s){return await i("articles").whereLike("text",`%${s}%`)}cleanSearch(s){let e="a, \xE0, agora, ainda, algu\xE9m, algum, alguma, algumas, alguns, ampla, amplas, amplo, amplos, ante, antes, ao, aos, ap\xF3s, aquela, aquelas, aquele, aqueles, aquilo, as, at\xE9, atrav\xE9s, cada, coisa, coisas, com, como, contra, contudo, da, daquele, daqueles, das, de, dela, delas, dele, deles, depois, dessa, dessas, desse, desses, desta, destas, deste, deste, destes, deve, devem, devendo, dever, dever\xE1, dever\xE3o, deveria, deveriam, devia, deviam, disse, disso, disto, dito, diz, dizem, do, dos, e, \xE9, ela, elas, ele, eles, em, enquanto, entre, era, essa, essas, esse, esses, esta, est\xE1, estamos, est\xE3o, estas, estava, estavam, est\xE1vamos, este, estes, estou, eu, fazendo, fazer, feita, feitas, feito, feitos, foi, for, foram, fosse, fossem, grande, grandes, h\xE1, isso, isto, j\xE1, la, l\xE1, lhe, lhes, lo, mas, me, mesma, mesmas, mesmo, mesmos, meu, meus, minha, minhas, muita, muitas, muito, muitos, na, n\xE3o, nas, nem, nenhum, nessa, nessas, nesta, nestas, ningu\xE9m, no, nos, n\xF3s, nossa, nossas, nosso, nossos, num, numa, nunca, o, os, ou, outra, outras, outro, outros, para, pela, pelas, pelo, pelos, pequena, pequenas, pequeno, pequenos, per, perante, pode, pude, podendo, poder, poderia, poderiam, podia, podiam, pois, por, por\xE9m, porque, posso, pouca, poucas, pouco, poucos, primeiro, primeiros, pr\xF3pria, pr\xF3prias, pr\xF3prio, pr\xF3prios, quais, qual, quando, quanto, quantos, que, quem, s\xE3o, se, seja, sejam, sem, sempre, sendo, ser\xE1, ser\xE3o, seu, seus, si, sido, s\xF3, sob, sobre, sua, suas, talvez, tamb\xE9m, tampouco, te, tem, tendo, tenha, ter, teu, teus, ti, tido, tinha, tinham, toda, todas, todavia, todo, todos, tu, tua, tuas, tudo, \xFAltima, \xFAltimas, \xFAltimo, \xFAltimos, um, uma, umas, uns, vendo, ver, vez, vindo, vir, vos, v\xF3s".split(", ");return s.split(" ").filter(r=>r&&e.every(o=>r.toLowerCase()!==o))}async searchArticleService(s){let e=this.cleanSearch(s),t=[],r=[];for(let c of e)t.push(await this.getArticlesByText(c)),t.push(await this.getArticlesByTitle(c)),t.push(await this.getArticlesBySubtitle(c));t.forEach(c=>{c.map(d=>r.push(d))});let o={};return r.filter(c=>o.hasOwnProperty(c.id)?!1:o={...o,[c.id]:!0})}}});var ds,ls,Ce,U,me=z(()=>{"use strict";ue();ds=(f(),O($)),ls=(p(),O(Q)),Ce=new S,U=class{async index(s,e){let{content:t,author:r}=s.query,o=await Ce.searchArticleService(t);e.json(o)}}});var fe=M((gs,pe)=>{"use strict";var de=require("express");me();var le=(0,de.Router)(),ke=new U;le.get("/",ke.index);pe.exports=le});var G=R(require("express"));p();var ge=require("express");var se=require("express");f();var A=class{async checkUsersPermissionsForCreate(s){let e=await i("users").where({id:s}).first();return!!(e.hierarchy&&e.hierarchy!=="reader")}async checkUsersPermissionForEdit(s,e){return!!await i("articles").where({id:e}).andWhere({user_id:s}).first()}async createArticle({title:s,subtitle:e,text:t,user_id:r,image:o,author:n}){try{return await i("articles").insert({title:s,subtitle:e,text:t,user_id:r,image:o,author:n}),{message:"Artigo criado com sucesso!"}}catch(c){return{error:c,message:"Error na cria\xE7\xE3o"}}}async updateArticle(s){if(!this.checkUsersPermissionForEdit(s.user_id,s.id))return{message:"forbidden"};try{await i("articles").where({id:s.id}).update(s)}catch(t){return{error:t}}return{message:"Artigo atualizado com sucesso"}}async deleteArticle({user_id:s,article_id:e}){if(!await this.checkUsersPermissionForEdit(s,e))return{message:"forbidden"};try{return await i("articles").where({id:e}).delete(),{message:"OK"}}catch(r){return{error:r}}}async getAllArticles(){return await i("articles")}async getArticleById(s){return await i("articles").where({id:s}).first()}async getArticlesByUserId(s){return await i("articles").where({user_id:s})}};p();var l=new A,q=class{async create(s,e){let{title:t,subtitle:r,text:o,user_id:n,image:c,author:d}=s.body;if(!await l.checkUsersPermissionsForCreate(n))return e.json({message:"Sem Permiss\xE3o",error:"forbidden"});let K=await l.createArticle({title:t,subtitle:r,text:o,user_id:n,image:c,author:d});return e.json(K)}async update(s,e){let{title:t,subtitle:r,text:o,id:n,user_id:c,image:d}=s.body,I=await l.updateArticle({title:t,subtitle:r,text:o,id:n,image:d,user_id:c});return e.json(I)}async delete(s,e){let{user_id:t,article_id:r}=s.body,o=await l.deleteArticle({article_id:r,user_id:t});return e.json(o)}async index(s,e){let t=await l.getAllArticles();e.json(t)}async show(s,e){let{id:t}=s.query,{user_id:r}=s.query;if(t){let o=await l.getArticleById(t);return o||e.send(new u("Esse Artigo n\xE3o existe ou foi excluido","not_found",404)),e.json(o)}else if(r){let o=await l.getArticlesByUserId(r);return o||e.send(new u("Esse Artigo n\xE3o existe ou foi excluido","not_found",404)),e.json(o)}else{let{user_id:o}=s.body;if(o){let n=await l.getArticlesByUserId(o);return n||e.send(new u("Esse Artigo n\xE3o existe ou foi excluido","not_found",404)),e.json(n)}return e.send(new u("Sem Par\xE2metros","not_found",404))}}};var ee=require("jsonwebtoken");var L={jwt:{secret:"default",expiresIn:"1d"}};async function m(a,s,e){let t=a.headers.authorization;if(t){let[,r]=t.split(" ");if(!r)return e();try{let{sub:o}=(0,ee.verify)(r,L.jwt.secret);return a.body={...a.body,token:r,user_id:Number(o)},e()}catch{return s.json({redirect:!0,message:"Token expired or invalid"})}}return e()}p();function x(a,s,e){let{user_id:t}=a.body;t||s.send(new u({redirect:!0,error:"User not logged in"},"not logged in")),e()}var g=(0,se.Router)(),h=new q;g.post("/create",m,x,h.create);g.put("/update",m,x,h.update);g.delete("/delete",m,x,h.delete);g.get("/show",h.show);g.get("/show/user",m,h.show);g.get("/show-all",h.index);var te=g;var re=require("express");f();var v=class{async createComment({user_id:s,article_id:e,title:t,text:r,name:o}){try{o||(o=await(await i("users").where({id:s}).first()).name),await i("comments").insert({user_id:s,article_id:e,title:t,text:r,name:o})}catch(n){return{error:n}}return{message:"Coment\xE1rio criado"}}async deleteComment({comments_id:s,article_id:e,user_id:t}){try{return await i("comments").where({id:s}).andWhere({article_id:e}).andWhere({user_id:t}).delete(),{message:"Coment\xE1rio deletado"}}catch(r){return{error:r,message:"Error Interno"}}}async getAllComments(s){try{return await i("comments").where({article_id:s})}catch(e){return e}}async getCommentById(s){try{return await i("comments").where({id:s}).first()}catch(e){return e}}async getCommentByUserId(s){try{return await i("comments").where({user_id:s})}catch(e){return e}}};p();var b=new v,C=class{async create(s,e){let{user_id:t,article_id:r,title:o,text:n,name:c}=s.body,d=await b.createComment({user_id:t,article_id:r,title:o,text:n,name:c});return e.json(d)}async index(s,e){let{article_id:t}=s.query,r=await b.getAllComments(t);return e.json(r)}async delete(s,e){let{comments_id:t,article_id:r,user_id:o}=s.body;if(!t)return e.json(new u("Coment\xE1rio Inexistente ou Exclu\xEDdo","not_found",404));let n=await b.deleteComment({comments_id:t,article_id:r,user_id:o});return e.json(n)}async show(s,e){let{id:t}=s.query;if(t){let n=await b.getCommentById(t);return e.json(n)}let{user_id:r}=s.body,o=await b.getCommentByUserId(r);return e.json(o)}};var w=(0,re.Router)(),k=new C;w.post("/create",m,k.create);w.delete("/delete",m,k.delete);w.get("/all",k.index);w.get("/show",k.show);w.get("/show/user",m,k.show);var oe=w;var ie=require("express");var ne=require("bcryptjs");var _=require("bcryptjs"),ae=require("jsonwebtoken");f();var Ze=(f(),O($)),N=class{constructor(){}async login(s){let{user_id:e,token:t,email:r,password:o}=s;if(e&&t){let B=await i("users").where({id:e}).first();return{token:t,user_id:B.user_id,name:B.name,avatar:B.avatar,hierarchy:B.hierarchy}}if(!r&&!o)return{error:"login failed",message:"Sem dados",redirect:!0};let n=await i("users").where({email:r}).first();if(!n)return{error:"login failed",message:"Dados incorretos"};if(!(0,_.compare)(o,n.password))return{error:"login failed",message:"Dados incorretos"};let{secret:d,expiresIn:I}=L.jwt;return{token:(0,ae.sign)({},d,{subject:String(n.id),expiresIn:I}),user_id:n.id,name:n.name,avatar:n.avatar,hierarchy:n.hierarchy}}async register(s){let{name:e,email:t,password:r}=s;if(await i("users").where({email:t}).first())return{error:"register failed",message:"Email Existente"};try{let n={name:e,email:t,avatar:null,password:r,hierarchy:"reader"};return await i("users").insert(n),{message:"Registro realizado com sucesso"}}catch(n){return{error:n,message:"Error interno"}}}async changePassword(s){let{user_id:e,oldPassword:t,newPassword:r}=s,o=await(await i("users").where({id:e}).first()).password;if(await(0,_.compare)(t,o))return{error:"update-password failed",message:"Senha Incorreta"};let c=await(0,_.hash)(r,8);try{await i("users").where({id:e}).update({password:c})}catch(d){return{error:d,message:"CRUD"}}return{message:"Senha alterada com sucesso"}}async changeAvatar(s){let{user_id:e,avatar:t}=s;try{await i("users").where({id:e}).update({avatar:t})}catch(r){return{error:r,message:"CRUD"}}return{message:"Avatar alterado com sucesso"}}async getAuthor(s){try{let e=await i("users").where({id:s}).first();return e?{id:e.id,name:e.name,avatar:e.avatar}:{error:"user not_found",message:"Usu\xE1rio n\xE3o encontrado"}}catch(e){return{error:e,message:"Server Error"}}}};p();var j=new N,P=class{async login(s,e){let{token:t,user_id:r,email:o,password:n}=s.body,c=await j.login({token:t,user_id:r,email:o,password:n});return e.json(c)}async create(s,e){let{name:t,email:r,password:o}=s.body,n=await(0,ne.hash)(o,8),c=await j.register({name:t,email:r,password:n});return e.json(c)}async update(s,e){let{user_id:t,avatar:r,newPassword:o,oldPassword:n}=s.body;if(!t)return e.json(new u("Sem Dados","redirect",401,"/login"));if(r){let c=await j.changeAvatar({user_id:t,avatar:r});return e.json({message:c})}else if(o){let c=await j.changePassword({user_id:t,newPassword:o,oldPassword:n});return e.json({message:c})}else return e.json(new u("Sem Dados","redirect",401,"/login"))}async getAuthor(s,e){let{id:t}=s.query;if(!t)return e.json(new u("Sem Dados"));let r=await j.getAuthor(t);return e.json(r)}};var y=(0,ie.Router)(),E=new P;y.post("/login",m,E.login);y.post("/register",E.create);y.put("/avatar",m,E.update);y.put("/change-password",m,E.update);y.get("/author",E.getAuthor);var ce=y;var D=(0,ge.Router)(),_e=fe();D.use("/users",ce);D.use("/comments",oe);D.use("/articles",te);D.use("/search",_e);var he=D;var ye=R(require("cors"));require("express-async-errors");var F=(0,G.default)();F.use((0,ye.default)());F.use(G.default.json({limit:"10mb"}));F.use(he);F.use(async(a,s,e,t)=>a instanceof u?e.status(a.status).json({status:"error",message:a.message,typeError:a.typeError}):e.status(500).json({status:"error",message:"erro do servidor"}));var we=process.env.PORT||3001;F.listen(we,()=>console.log("Server is Running:",we));
